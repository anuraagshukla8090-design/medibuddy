"use client"

import { useSearchParams } from "next/navigation"
import { useState } from "react"
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  CartesianGrid,
  PieChart,
  Pie,
  Cell,
  RadarChart,
  Radar,
  PolarGrid,
  PolarAngleAxis,
  PolarRadiusAxis
} from "recharts"

export default function Dashboard() {
  const params = useSearchParams()

  const riskPercent = Number(params.get("risk")) || 0
  const category = params.get("category") || "Low"
  const severity = params.get("severity") || "Low Risk"
  const bmi = Number(params.get("bmi")) || 0
  const healthScore = Number(params.get("score")) || 0
  const healthLevel = params.get("healthLevel") || "Good"
  const lifestyleScore = Number(params.get("lifestyle")) || 0
  const confidence = Number(params.get("confidence")) || 0
  const idealMin = params.get("idealMin") || "-"
  const idealMax = params.get("idealMax") || "-"
  const factors = params.get("factors")?.split(",").filter(Boolean) || []
  const recommendations =
  params.get("recommendations")?.split("|").filter(Boolean) || []


  const barData = [
    { name: "Health Score", value: healthScore },
    { name: "Lifestyle", value: lifestyleScore },
    { name: "Confidence", value: confidence },
  ]

  const pieData = [
    { name: "Risk", value: riskPercent },
    { name: "Safe", value: 100 - riskPercent },
  ]

  const radarData = [
    { metric: "Heart Risk", value: riskPercent },
    { metric: "Lifestyle", value: lifestyleScore },
    { metric: "Health Score", value: healthScore },
    { metric: "Confidence", value: confidence },
  ]
//pdf function
const jsPDF =require("jspdf")



const downloadReport = async () => {
  const jsPDF = (await import("jspdf")).default
  const pdf = new jsPDF()

  const today = new Date().toLocaleDateString()
  const reportId = "HR-" + Date.now()

  // ===== HEADER =====
  pdf.setFillColor(33, 150, 243)
  pdf.rect(0, 0, 210, 25, "F")

  pdf.setTextColor(255, 255, 255)
  pdf.setFontSize(18)
  pdf.text("AI Clinical Health Risk Report", 20, 16)

  pdf.setFontSize(10)
  pdf.text(`Report ID: ${reportId}`, 150, 10)
  pdf.text(`Date: ${today}`, 150, 18)

  pdf.setTextColor(0, 0, 0)

  let y = 40

  // ===== RISK SECTION =====
  pdf.setFontSize(14)
  pdf.text("Risk Overview", 20, y)
  y += 10

  pdf.setFontSize(12)
  pdf.text(`Risk Percentage: ${riskPercent}%`, 20, y)
  y += 8

  pdf.text(`Risk Category: ${category}`, 20, y)
  y += 8

  pdf.text(`Severity: ${severity}`, 20, y)
  y += 12

  // ===== SCORES =====
  pdf.setFontSize(14)
  pdf.text("Health Scores", 20, y)
  y += 10

  pdf.setFontSize(12)
  pdf.text(`Health Score: ${healthScore}/100`, 20, y)
  y += 8

  pdf.text(`Lifestyle Score: ${lifestyleScore}/100`, 20, y)
  y += 8

  pdf.text(`Model Confidence: ${confidence}%`, 20, y)
  y += 12

  // ===== BMI =====
  pdf.setFontSize(14)
  pdf.text("BMI Analysis", 20, y)
  y += 10

  pdf.setFontSize(12)
  pdf.text(`BMI: ${bmi}`, 20, y)
  y += 8

  pdf.text(`Health Level: ${healthLevel}`, 20, y)
  y += 8

  pdf.text(`Ideal Weight Range: ${idealMin}kg - ${idealMax}kg`, 20, y)
  y += 12

  // ===== RISK FACTORS =====
  pdf.setFontSize(14)
  pdf.text("Identified Risk Factors", 20, y)
  y += 10

  pdf.setFontSize(12)

  if (factors.length === 0) {
    pdf.text("No major risk factors detected.", 20, y)
    y += 8
  } else {
    factors.forEach((factor: string) => {
      pdf.text(`• ${factor}`, 25, y)
      y += 8
    })
  }

  y += 6

  // ===== RECOMMENDATIONS =====
  pdf.setFontSize(14)
  pdf.text("Personalized Recommendations", 20, y)
  y += 10

  pdf.setFontSize(12)

  if (recommendations.length === 0) {
    pdf.text("Maintain current healthy lifestyle.", 20, y)
  } else {
    recommendations.forEach((rec: string) => {
      const splitText = pdf.splitTextToSize(`• ${rec}`, 160)
      pdf.text(splitText, 25, y)
      y += splitText.length * 7
    })
  }

  // ===== FOOTER =====
  pdf.setFontSize(9)
  pdf.setTextColor(120)
  pdf.text(
    "Generated by AI Health Prediction System | This is not a medical diagnosis.",
    20,
    285
  )

  pdf.save("AI_Health_Report.pdf")
}
//gemini
const [message, setMessage] = useState("")
const [reply, setReply] = useState("")
const [loadingAI, setLoadingAI] = useState(false)

const askAI = async () => {
  setLoadingAI(true)

  const res = await fetch("http://localhost:8000/chat", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: message   // must match backend model
    })
  })

  const data = await res.json()
  setReply(data.reply)
  setLoadingAI(false)
}





  return (
    <div id="report-content" className="min-h-screen bg-gray-100 p-10 text-gray-800">

      <h1 className="text-4xl font-bold mb-10">
        Clinical Health Analytics Dashboard
      </h1>
      <button
  onClick={downloadReport}
  className="mb-8 px-6 py-3 text-white bg-blue-600 hover:bg-blue-700 rounded-xl font-medium transition"
>
  Download Report (PDF)
</button>


      {/* ================= RISK SUMMARY ================= */}
      <div className="bg-white rounded-3xl shadow-lg p-8 mb-10">
        <h2 className="text-xl font-semibold mb-4">
          Cardiac Risk Summary
        </h2>

        <div className="flex items-center justify-between">
          <div className="text-5xl font-bold text-indigo-600">
            {riskPercent}%
          </div>

          <div className="text-right">
            <div className="text-lg font-semibold">
              {severity}
            </div>
            <div className="text-sm text-gray-500">
              Category: {category}
            </div>
          </div>
        </div>

        <div className="w-full bg-gray-200 rounded-full h-4 mt-6">
          <div
            className="bg-indigo-600 h-4 rounded-full transition-all duration-700"
            style={{ width: `${riskPercent}%` }}
          />
        </div>
      </div>

      {/* ================= METRIC CARDS ================= */}
      <div className="grid grid-cols-3 gap-8 mb-12">

        <MetricCard title="Health Score" value={`${healthScore}/100`} subtitle={healthLevel} />
        <MetricCard title="Lifestyle Score" value={`${lifestyleScore}/100`} subtitle="Lifestyle Evaluation" />
        <MetricCard title="Model Confidence" value={`${confidence}%`} subtitle="Prediction Reliability" />

      </div>

      {/* ================= BAR CHART ================= */}
      <div className="bg-white rounded-3xl shadow-lg p-8 mb-10">
        <h2 className="text-xl font-semibold mb-6">
          Score Comparison
        </h2>

        <div className="h-72">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={barData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="name" />
              <YAxis domain={[0, 100]} />
              <Tooltip />
              <Bar dataKey="value" fill="#6366f1" radius={[8, 8, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* ================= PIE CHART ================= */}
      <div className="bg-white rounded-3xl shadow-lg p-8 mb-10">
        <h2 className="text-xl font-semibold mb-6">
          Risk Distribution
        </h2>

        <div className="h-72 flex justify-center">
          <ResponsiveContainer width="60%" height="100%">
            <PieChart>
              <Pie
                data={pieData}
                innerRadius={60}
                outerRadius={100}
                dataKey="value"
              >
                <Cell fill="#ef4444" />
                <Cell fill="#22c55e" />
              </Pie>
              <Tooltip />
            </PieChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* ================= RADAR CHART ================= */}
      <div className="bg-white rounded-3xl shadow-lg p-8 mb-10">
        <h2 className="text-xl font-semibold mb-6">
          Multi-Metric Radar Analysis
        </h2>

        <div className="h-80">
          <ResponsiveContainer width="100%" height="100%">
            <RadarChart outerRadius={120} data={radarData}>
              <PolarGrid />
              <PolarAngleAxis dataKey="metric" />
              <PolarRadiusAxis domain={[0, 100]} />
              <Radar
                dataKey="value"
                stroke="#6366f1"
                fill="#6366f1"
                fillOpacity={0.6}
              />
              <Tooltip />
            </RadarChart>
          </ResponsiveContainer>
        </div>
      </div>

      {/* ================= BMI PANEL ================= */}
      <div className="bg-white rounded-3xl shadow-lg p-8 mb-10">
        <h2 className="text-xl font-semibold mb-4">
          BMI & Weight Analysis
        </h2>

        <div className="text-3xl font-bold mb-3">
          BMI: {bmi}
        </div>

        <p className="text-gray-600">
          Ideal Weight Range: {idealMin}kg - {idealMax}kg
        </p>
      </div>

      {/* ================= RISK FACTORS ================= */}
      <div className="bg-white rounded-3xl shadow-lg p-8">
        <h2 className="text-xl font-semibold mb-4">
          Identified Risk Factors
        </h2>

        {factors.length > 0 ? (
          <div className="flex flex-wrap gap-3">
            {factors.map((f, i) => (
              <span
                key={i}
                className="px-4 py-2 bg-red-100 text-red-600 rounded-full text-sm"
              >
                {f}
              </span>
            ))}
          </div>
        ) : (
          <p className="text-green-600">
            No major risk factors detected.
          </p>
        )}
      </div>
      {/* ================= RECOMMENDATIONS ================= */}
<div className="bg-white rounded-3xl shadow-lg p-8 mt-10">
  <h2 className="text-xl font-semibold mb-4">
    Personalized Recommendations
  </h2>

  {recommendations.length > 0 ? (
    <div className="space-y-3">
      {recommendations.map((rec, i) => (
        <div
          key={i}
          className="bg-green-100 text-green-700 px-4 py-3 rounded-xl"
        >
          {rec}
        </div>
      ))}
    </div>
  ) : (
    <p className="text-gray-500">
      Maintain your current healthy lifestyle.
    </p>
  )}
</div>





    </div>
  )
}

function MetricCard({ title, value, subtitle }: any) {
  return (
    <div className="bg-white rounded-3xl shadow-lg p-6 text-center">
      <h3 className="text-gray-500 text-sm uppercase tracking-wide mb-2">
        {title}
      </h3>
      <div className="text-3xl font-bold text-indigo-600">
        {value}
      </div>
      <p className="text-sm text-gray-400 mt-2">{subtitle}</p>
    </div>
  )
}
